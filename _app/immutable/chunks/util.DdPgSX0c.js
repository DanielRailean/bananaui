var E=Object.defineProperty;var O=(i,e,t)=>e in i?E(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var h=(i,e,t)=>(O(i,typeof e!="symbol"?e+"":e,t),t);import{g as T,b as m}from"./entry.BEtSY_wd.js";import{O as d}from"./scheduler.BZuy4PaE.js";import{u as A,D as _,c as b,p as v}from"./stores.s1iyYYHd.js";import{a as C,e as k,i as G,c as R}from"./toastStore.Bxy57eWq.js";function I(i,e="GET",t,s){s||(s={}),t&&(s["content-type"]="application/json");const r={method:e,headers:s,body:JSON.stringify(t)};return fetch(i,r)}let n={};function f(i){if(i){for(const e of Object.keys(n))e.includes(i)&&(n[e]=void 0,console.log(`cleared cache key ${e}`));return}n={}}async function $(i,e="GET",t,s,r,a){if(a&&(n[r??i]=void 0),e=="GET"&&d(v.useEphemeralGetRequestsCache)){if(n[r??i])return console.log(`[GET] cache hit. Total cache keys: ${Object.keys(n).length}`),n[r??i];const c=await o(i,e,t,s);c.ok&&(n[r??i]=c)}return o(i,e,t,s)}async function o(i,e="GET",t,s){const r=await I(i,e,t,s),a={ok:r.ok,code:r.status};if(r.ok)try{a.data=await r.json()}catch{}else{a.err=await r.text();try{a.errTyped=JSON.parse(a.err)}catch{}}return a}class q{constructor(e,t,s){h(this,"endpoint");h(this,"headers");this.endpoint=e,this.headers={...s},t&&(this.headers.authorization=`Bearer ${t}`)}getInfo(){return o(this.endpoint,void 0,void 0,this.headers)}request(e,t="GET",s,r=this.headers){return $(`${this.endpoint}${e.startsWith("/")?e:`/${e}`}`,t,s,{...this.headers,...r},e.startsWith("/")?e:`/${e}`)}schema(e){return o(`${this.endpoint}/schemas/${e}`,void 0,void 0,this.headers)}pluginConfig(e){return o(`${this.endpoint}/schemas/plugins/${e}`,void 0,void 0,this.headers)}async findAll(e,t={},s="",r=!1){return $(`${this.endpoint}${s}/${e}?size=${d(v.paginationSizeApi)}&sort_by=updated_at`,void 0,void 0,this.headers,`${s}/${e}?size=${d(v.paginationSizeApi)}&sort_by=updated_at`,r)}findRecord(e,t,s=""){return $(`${this.endpoint}${s}/${e}/${t}`,void 0,void 0,this.headers,`/${e}/${t}`)}createRecord(e,t,s=""){return o(`${this.endpoint}${s}/${e}`,"POST",t,this.headers)}async updateRecord(e,t,s,r=""){const a=await o(`${this.endpoint}${r}/${e}/${t}`,"PATCH",s,this.headers);return a.ok&&f(e),a}async deleteRecord(e,t,s=""){var a;if(e=="services"){const c=await(await u()).findAll("routes",{},`/services/${t}`);if(!c.ok)return k(`failed to load routes for service ${t}`),c;for(const l of((a=c.data)==null?void 0:a.data)??[]){const w=await this.deleteRecord("routes",l.id);w.ok?G(`service route ${l.id} deleted!`):(k(`failed to delete service route with id ${l.id}. ${w.err}`),f(t))}f("routes")}const r=await o(`${this.endpoint}${s}/${e}/${t}`,"DELETE",void 0,this.headers);return r.ok&&f(e),r}}let p;const y=3;let u=async i=>{var s,r;i&&i>y&&C({message:`Failed to return apiService after ${y} retries`});const e=d(A);if(e&&_.now().toUnixInteger()>e.expires&&(A.set(void 0),T(`${m}/login?auto=true`)),p)return p;const t=(s=d(b))==null?void 0:s.config;return t?!e&&((r=t.oidc)!=null&&r.enabled)?(T(`${m}/login`),await S(200),await u(i?i+1:0)):(p=new q(t.kongApi.endpoint,e==null?void 0:e.token,t.kongApi.requestHeaders),p):(await S(200),await u(i?i+1:0))};const S=i=>new Promise(e=>setTimeout(e,i)),D=(i,e=()=>{R("copied")})=>{navigator.clipboard.writeText(i).then(e,()=>{})};function F(i){return i?i.charAt(0).toUpperCase()+i.slice(1):""}const z="BANANA_UI_CONFIG";function M(){const i=localStorage.getItem(z);if(i)return JSON.parse(i)}let g;async function W(){if(g)return g;let e=(await(await u()).getInfo()).data;const t={};let s=Object.entries((e==null?void 0:e.plugins.available_on_server)??{}).sort((r,a)=>a[1].priority-r[1].priority);for(const r of s)t[r[0]]=r[1].priority;return g=t,t}async function J(i="/"){var t;return(t=(await(await u()).findAll("plugins",{},i)).data)==null?void 0:t.data}export{z as L,u as a,n as b,F as c,S as d,J as e,f,W as g,M as h,D as w};
